using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Redecard.PN.Extrato.Agentes.ServicoConsultaSuspensao;
using Redecard.PN.Extrato.Agentes.Tradutores;
using Redecard.PN.Extrato.Comum;
using Redecard.PN.Extrato.Comum.Helper;
using Redecard.PN.Extrato.Modelo;
using Redecard.PN.Comum;

namespace Redecard.PN.Extrato.Agentes
{
    public class ConsultarSuspensaoAG : AgentesBase
    {
        #region WACA1111 - Relatório de créditos suspensos, retidos e penhorados - Créditos suspensos.
        /// <summary>
        /// WACA1111 - Relatório de créditos suspensos, retidos e penhorados - Créditos suspensos.
        /// </summary>
        /// <param name="statusRetornoDTO"></param>
        /// <param name="envio"></param>
        /// <returns></returns>
        public ConsultarSuspensaoRetornoDTO ConsultarSuspensao(out StatusRetornoDTO statusRetornoDTO, ConsultarSuspensaoEnvioDTO envio)
        {
            string FONTE_METODO = this.GetType().Name + ".ConsultarSuspensao";

            using (Logger Log = Logger.IniciarLog("Relatório de créditos suspensos, retidos e penhorados - Créditos suspensos [WACA1111]"))
            {
                Log.GravarLog(EventoLog.InicioAgente, new { envio });

                try
                {
                    ConsultarSuspensaoRetornoDTO result = null;

                    using (SuspensoesClient cliente = new SuspensoesClient())
                    {
                        string programaChamador = "WACA1111";
                        string sistema = "IS";
                        string usuario = "xxx";
                        string dataInicial = envio.DataInicial.ToString("dd/MM/yyyy");
                        string dataFinal = envio.DataFinal.ToString("dd/MM/yyyy");
                        string mensagemRetorno = string.Empty;
                        string indicadorReChamada = string.Empty;
                        short quantidadeTransacoes = 0;
                        short numeroTransacaoEnviada = 0;
                        string tipoSuspensao = envio.TipoSuspensao;
                        string reservaDados = string.Empty;
                        string dados;

                        do
                        {
                            dados = (envio.CodigoBandeira.ToString("000") +
                                               envio.Estabelecimentos.Count.ToString("0000") +
                                               string.Join("", from i in envio.Estabelecimentos select i.ToString("000000000")).PadRight(27007, '0')).PadRight(30000, ' ');

                            Log.GravarLog(EventoLog.ChamadaHIS, new { programaChamador, sistema, usuario, dataInicial, dataFinal, mensagemRetorno, indicadorReChamada, quantidadeTransacoes, numeroTransacaoEnviada, tipoSuspensao, reservaDados, dados });
                            short codigoRetorno;

                            if (!TesteHelper.IsAmbienteDesenvolvimento())
                            {
                                codigoRetorno = cliente.ConsultarSuspensao(programaChamador, sistema, ref usuario, dataInicial, dataFinal, ref mensagemRetorno, ref indicadorReChamada, ref quantidadeTransacoes, ref numeroTransacaoEnviada, ref tipoSuspensao, ref reservaDados, ref dados);
                            }
                            else
                            {
                                codigoRetorno = 10;

                                //dados = "000079DT11.03.201121.03.200722.03.2007012428442080100443MAESTRO     00000VDA DEBITO                          00000000000001942104004953000022850DT11.03.201122.03.200723.03.2007012428442081100554MAESTRO     00000VDA DEBITO                          00000000000002784104004953000022850DT11.03.201123.03.200726.03.2007012428442082103769MAESTRO     00000VDA DEBITO                          00000000000003735104004953000022850DT11.03.201125.03.200726.03.2007012428442084052790MAESTRO     00000VDA DEBITO                          00000000000005392104004953000022850DT11.03.201126.03.200727.03.2007012428442085095105MAESTRO     00000VDA DEBITO                          00000000000003706104004953000022850DT11.03.201127.03.200728.03.2007012428442086096405MAESTRO     00000VDA DEBITO                          00000000000002574104004953000022850DT11.03.201128.03.200729.03.2007012428442087097926MAESTRO     00000VDA DEBITO                          00000000000004868104004953000022850DT11.03.201129.03.200730.03.2007012428442088099310MAESTRO     00000VDA DEBITO                          00000000000007461104004953000022850DT11.03.201130.03.200702.04.2007012428442089106023MAESTRO     00000VDA DEBITO                          00000000000008411104004953000022850DT11.03.201101.04.200702.04.2007012428442091053880MAESTRO     00000VDA DEBITO                          00000000000000727104004953000022850DT11.03.201102.04.200703.04.2007012428442092097232MAESTRO     00000VDA DEBITO                          00000000000002284104004953000022850DT11.03.201103.04.200704.04.2007012428442093104229MAESTRO     00000VDA DEBITO                          00000000000001648104004953000022850DT11.03.201104.04.200705.04.2007012428442094104100MAESTRO     00000VDA DEBITO                          00000000000005463104004953000022850DT11.03.201105.04.200709.04.2007012428442095111197MAESTRO     00000VDA DEBITO                          00000000000001517104004953000022850DT11.03.201107.04.200709.04.2007012428442097107447MAESTRO     00000VDA DEBITO                          00000000000001848104004953000022850DT11.03.201108.04.200709.04.2007012428442098051496MAESTRO     00000VDA DEBITO                          00000000000001346104004953000022850DT11.03.201109.04.200710.04.2007012428442099097608MAESTRO     00000VDA DEBITO                          00000000000008226104004953000022850DT11.03.201112.04.200713.04.2007012428442102099638MAESTRO     00000VDA DEBITO                          00000000000001801104004953000022850DT11.03.201113.04.200716.04.2007012428442103105580MAESTRO     00000VDA DEBITO                          00000000000016165104004953000022850DT11.03.201114.04.200716.04.2007012428442104108914MAESTRO     00000VDA DEBITO                          00000000000005676104004953000022850DT11.03.201116.04.200717.04.2007012428442106093326MAESTRO     00000VDA DEBITO                          00000000000002393104004953000022850DT11.03.201117.04.200718.04.2007012428442107096737MAESTRO     00000VDA DEBITO                          00000000000001931104004953000022850DT11.03.201118.04.200719.04.2007012428442108098510MAESTRO     00000VDA DEBITO                          00000000000003201104004953000022850DT11.03.201119.04.200720.04.2007012428442109099461MAESTRO     00000VDA DEBITO                          00000000000013568104004953000022850DT11.03.201120.04.200723.04.2007012428442110106519MAESTRO     00000VDA DEBITO                          00000000000000665104004953000022850DT11.03.201121.04.200723.04.2007012428442111074578MAESTRO     00000VDA DEBITO                          00000000000001711104004953000022850DT11.03.201123.04.200724.04.2007012428442113092574MAESTRO     00000VDA DEBITO                          00000000000006864104004953000022850DT11.03.201124.04.200725.04.2007012428442114097124MAESTRO     00000VDA DEBITO                          00000000000008442104004953000022850DT11.03.201125.04.200726.04.2007012428442115098366MAESTRO     00000VDA DEBITO                          00000000000001851104004953000022850DT11.03.201127.04.200730.04.2007012428442117103605MAESTRO     00000VDA DEBITO                          00000000000010593104004953000022850DT11.03.201128.04.200730.04.2007012428442118109534MAESTRO     00000VDA DEBITO                          00000000000002179104004953000022850DT11.03.201102.05.200703.05.2007012428442122100565MAESTRO     00000VDA DEBITO                          00000000000001165104004953000022850DT11.03.201103.05.200704.05.2007012428442123101547MAESTRO     00000VDA DEBITO                          00000000000012892104004953000022850DT11.03.201104.05.200707.05.2007012428442124106572MAESTRO     00000VDA DEBITO                          00000000000022470104004953000022850DT11.03.201106.05.200707.05.2007012428442126055432MAESTRO     00000VDA DEBITO                          00000000000000617104004953000022850DT11.03.201107.05.200708.05.2007012428442127099664MAESTRO     00000VDA DEBITO                          00000000000003815104004953000022850DT11.03.201108.05.200709.05.2007012428442128102410MAESTRO     00000VDA DEBITO                          00000000000001209104004953000022850DT11.03.201109.05.200710.05.2007012428442129102333MAESTRO     00000VDA DEBITO                          00000000000012174104004953000022850DT11.03.201110.05.200711.05.2007012428442130105279MAESTRO     00000VDA DEBITO                          00000000000004013104004953000022850DT11.03.201111.05.200714.05.2007012428442131111719MAESTRO     00000VDA DEBITO                          00000000000011826104004953000022850DT11.03.201112.05.200714.05.2007012428442132118055MAESTRO     00000VDA DEBITO                          00000000000005208104004953000022850DT11.03.201114.05.200715.05.2007012428442134096593MAESTRO     00000VDA DEBITO                          00000000000000980104004953000022850DT11.03.201115.05.200721.05.2007012428442139107824MAESTRO     00000VDA DEBITO                          00000000000002467104004953000022850T111.03.2011                                      MAESTRO     00000Total Suspensão Dia MAESTRO         00000000000219808104004953000022850T211.03.2011                                                  00000Total Suspensão Dia                 00000000000219808                  DT12.03.201125.03.200702.03.2011012428442060049989DINERS CLUB 00001VDA CREDITO                         000000000000011131040049500495     DT12.03.201125.03.200702.03.2011012428442060049989DINERS CLUB 00001VDA CREDITO                         000000000000011131040049500495     DT12.03.201125.03.200702.03.2011012428442060049989DINERS CLUB 00001VDA CREDITO                         000000000000004901040049500495     DT12.03.201126.03.200702.03.2011012428442032632610MASTERCARD  00001VDA CREDITO                         000000000000061191040049500495     DT12.03.201129.03.200702.03.2011012428442055029760PRIVATE LAB 00001VDA CREDITO                         000000000000072451040049500495     DT12.03.201130.03.200702.03.2011012428442062731599MASTERCARD  00001VDA CREDITO                         000000000000009411040049500495     DT12.03.201103.04.200702.03.2011012428442091029884MASTERCARD  00001VDA CREDITO                         000000000000019101040049500495     DT12.03.201109.04.200702.03.2011012428442030732774MASTERCARD  00001VDA CREDITO                         000000000000012091040049500495     DT12.03.201111.04.200702.03.2011012428442044731101MASTERCARD  00001VDA CREDITO                         000000000000014621040049500495     DT12.03.201115.04.200702.03.2011012428442075432554MASTERCARD  00001VDA CREDITO                         000000000000020301040049500495     DT12.03.201116.04.200702.03.2011012428442081331105MASTERCARD  00001VDA CREDITO                         000000000000045231040049500495     DT12.03.201117.04.200702.03.2011012428442088729909MASTERCARD  00001VDA CREDITO                         000000000000026101040049500495     DT12.03.201118.04.200702.03.2011012428442096231526MASTERCARD  00001VDA CREDITO                         000000000000013521040049500495     DT12.03.201121.04.200702.03.2011012428442019532949MASTERCARD  00001VDA CREDITO                         000000000000074711040049500495     DT12.03.201123.04.200702.03.2011012428442031431492MASTERCARD  00001VDA CREDITO                         000000000000031911040049500495     DT12.03.201125.04.200702.03.2011012428442046230054MASTERCARD  00001VDA CREDITO                         000000000000031531040049500495     DT12.03.201126.04.200702.03.2011012428442053830954MASTERCARD  00001VDA CREDITO                         000000000000075491040049500495     DT12.03.201127.04.200702.03.2011012428442061630352MASTERCARD  00001VDA CREDITO                         000000000000187391040049500495     DT12.03.201101.05.200702.03.2011012428442090329228MASTERCARD  00001VDA CREDITO                         000000000000041251040049500495     DT12.03.201102.05.200702.03.2011012428442095931034MASTERCARD  00001VDA CREDITO                         000000000000008751040049500495     DT12.03.201104.05.200702.03.2011012428442010829626MASTERCARD  00001VDA CREDITO                         000000000000055281040049500495     DT12.03.201108.05.200702.03.2011012428442039129986MASTERCARD  00001VDA CREDITO                         000000000000035231040049500495     DT12.03.201111.05.200702.03.2011012428442062029904MASTERCARD  00001VDA CREDITO                         000000000000021401040049500495     DT12.03.201114.05.200702.03.2011012428442084931308MASTERCARD  00001VDA CREDITO                         000000000000017511040049500495     DT12.03.201114.05.200702.03.2011012428442084931309MASTERCARD  00001VDA CREDITO                         000000000000029801040049500495     T112.03.2011                                      DINERS CLUB 00003Total Suspensão Dia DINERS CLUB     000000000000027161040049500495     T112.03.2011                                      MASTERCARD  00021Total Suspensão Dia MASTERCARD      000000000000831811040049500495     T112.03.2011                                      PRIVATE LAB 00001Total Suspensão Dia PRIVATE LAB     000000000000072451040049500495     T212.03.2011                                                  00025Total Suspensão Dia                 00000000000093142                  T3                                                MAESTRO     00000Total Suspensão Período MAESTRO     00000000000219808104004953000022850T3                                                DINERS CLUB 00003Total Suspensão Período DINERS CLUB 000000000000027161040049500495     T3                                                MASTERCARD  00021Total Suspensão Período MASTERCARD  000000000000831811040049500495     T3                                                PRIVATE LAB 00001Total Suspensão Período PRIVATE LAB 000000000000072451040049500495     T4                                                            00025Total Suspensão Período             00000000000312950                                                  000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000                                          000000000000000000            00000                                    0000000000000000000000000          0002500000000000312950";
                                dados = String.Empty;
                            }

                            statusRetornoDTO = new StatusRetornoDTO(codigoRetorno, mensagemRetorno, FONTE_METODO);

                            ConsultarSuspensaoRetornoDTO retornoDTO = TradutorResultadoConsultaSuspensao.TraduzirRetornoConsultarSuspensao(dados);
                            Log.GravarLog(EventoLog.RetornoHIS, new { codigoRetorno, mensagemRetorno, usuario, dataInicial, dataFinal, indicadorReChamada, quantidadeTransacoes, numeroTransacaoEnviada, tipoSuspensao, reservaDados, dados });

                            if (result == null)
                            {
                                result = retornoDTO;
                            }
                            else
                            {
                                result.Registros.AddRange(retornoDTO.Registros);

                                result.Totais = retornoDTO.Totais;
                            }

                        } while (indicadorReChamada == "S");
                    }

                    Log.GravarLog(EventoLog.FimAgente, new { result });

                    return result;
                }
                catch (Exception ex)
                {
                    Log.GravarErro(ex);

                    throw new PortalRedecardException(CODIGO_ERRO, FONTE, ex);
                }
            }
        }
        #endregion

        #region WACA1112 - Relatório de créditos suspensos, retidos e penhorados - Créditos penhorados.
        /// <summary>
        /// WACA1112 - Relatório de créditos suspensos, retidos e penhorados - Créditos penhorados.
        /// </summary>
        /// <param name="statusRetornoDTO"></param>
        /// <param name="envio"></param>
        /// <returns></returns>
        public ConsultarPenhoraRetornoDTO ConsultarPenhora(out StatusRetornoDTO statusRetornoDTO, ConsultarPenhoraEnvioDTO envio)
        {
            string FONTE_METODO = this.GetType().Name + ".ConsultarPenhora";
            using (Logger Log = Logger.IniciarLog("Relatório de créditos suspensos, retidos e penhorados - Créditos penhorados [WACA1112]"))
            {
                Log.GravarLog(EventoLog.InicioAgente, new { envio });

                try
                {
                    ConsultarPenhoraRetornoDTO result = null;

                    using (SuspensoesClient cliente = new SuspensoesClient())
                    {
                        string programaChamador = "WACA1112";
                        string sistema = "IS";
                        string usuario = "xxx";
                        string dataInicial = envio.DataInicial.ToString("dd/MM/yyyy");
                        string dataFinal = envio.DataFinal.ToString("dd/MM/yyyy");
                        string mensagemRetorno = string.Empty;
                        string indicadorReChamada = string.Empty;
                        short quantidadeTransacoes = 0;
                        short numeroTransacaoEnviada = 0;
                        string reservaDados = string.Empty;
                        string dados;

                        do
                        {
                            dados = (envio.CodigoBandeira.ToString("000") +
                                               envio.Estabelecimentos.Count.ToString("0000") +
                                               string.Join("", from i in envio.Estabelecimentos select i.ToString("000000000")).PadRight(27007, '0')).PadRight(30000, ' ');

                            short codigoRetorno;
                            Log.GravarLog(EventoLog.ChamadaHIS, new { programaChamador, sistema, usuario, dataInicial, dataFinal, mensagemRetorno, indicadorReChamada, quantidadeTransacoes, numeroTransacaoEnviada, reservaDados, dados });
                            if (!TesteHelper.IsAmbienteDesenvolvimento())
                            {
                                codigoRetorno = cliente.ConsultarPenhora(programaChamador, sistema, ref usuario, dataInicial, dataFinal, ref mensagemRetorno, ref indicadorReChamada, ref quantidadeTransacoes, ref numeroTransacaoEnviada, ref reservaDados, ref dados);
                            }
                            else
                            {
                                codigoRetorno = 0;
                                dados = "000011PRNET5498978     0000000000003767500008                                                                                                                   DT28.08.200127.08.200114.09.2001003878902001400937MasterCard  00001VDA CREDITO                                                           00000000000002312DT28.08.200127.08.200114.09.2001003878902005427095MasterCard  00001VDA CREDITO                                                           00000000000001000DT28.08.200127.08.200114.09.2001003878902078349168MasterCard  00001VDA CREDITO                                                           00000000000008043DT28.08.200127.08.200114.09.2001003878902081129030MasterCard  00001VDA CREDITO                                                           00000000000003398DT28.08.200127.08.200114.09.2001003878902083729210MasterCard  00001VDA CREDITO                                                           00000000000005476DT28.08.200127.08.200114.09.2001003878902086330973MasterCard  00001VDA CREDITO                                                           00000000000010060DT29.08.200128.08.200114.09.2001003878902089130610MasterCard  00001VDA CREDITO                                                           00000000000001765DT30.08.200129.08.200114.09.2001003878902091929319MasterCard  00001VDA CREDITO                                                           00000000000005621T1                                      0        0MasterCard  00008Total Penhora Processo MasterCard                                     00000000000037675TP                                      0        0            00008Total Penhora Processo                                                00000000000037675                 0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                                    0000000000000000000000                                                                                                                   00008000010000000000003767500000000000037675";
                            }

                            statusRetornoDTO = new StatusRetornoDTO(codigoRetorno, mensagemRetorno, FONTE_METODO);

                            Log.GravarLog(EventoLog.RetornoHIS, new { codigoRetorno, mensagemRetorno, usuario, indicadorReChamada, quantidadeTransacoes, numeroTransacaoEnviada, reservaDados, dados });
                            ConsultarPenhoraRetornoDTO retornoDTO = TradutorResultadoConsultaSuspensao.TraduzirRetornoConsultarPenhora(dados);


                            if (result == null)
                            {
                                result = retornoDTO;
                            }
                            else
                            {
                                result.Registros.AddRange(retornoDTO.Registros);

                                result.Totais = retornoDTO.Totais;
                            }

                        } while (indicadorReChamada == "S");
                    }

                    Log.GravarLog(EventoLog.FimAgente, new { result });

                    return result;
                }
                catch (Exception ex)
                {
                    Log.GravarErro(ex);
                    throw new PortalRedecardException(CODIGO_ERRO, FONTE, ex);
                }
            }
        }
        #endregion

        #region WACA1113 - Relatório de créditos suspensos, retidos e penhorados - Créditos retidos.
        /// <summary>
        /// WACA1113 - Relatório de créditos suspensos, retidos e penhorados - Créditos retidos.
        /// </summary>
        /// <param name="statusRetornoDTO"></param>
        /// <param name="envio"></param>
        /// <returns></returns>
        public ConsultarRetencaoRetornoDTO ConsultarRetencao(out StatusRetornoDTO statusRetornoDTO, ConsultarRetencaoEnvioDTO envio)
        {
            string FONTE_METODO = this.GetType().Name + ".ConsultarRetencao";

            using (Logger Log = Logger.IniciarLog("Relatório de créditos suspensos, retidos e penhorados - Créditos retidos [WACA1113]"))
            {


                Log.GravarLog(EventoLog.InicioAgente, new { envio });

                try
                {
                    ConsultarRetencaoRetornoDTO result = null;

                    using (SuspensoesClient cliente = new SuspensoesClient())
                    {
                        string programaChamador = "WACA1113";
                        string sistema = "IS";
                        string usuario = "xxx";
                        string dataInicial = envio.DataInicial.ToString("dd/MM/yyyy");
                        string dataFinal = envio.DataFinal.ToString("dd/MM/yyyy");
                        string mensagemRetorno = string.Empty;
                        string indicadorReChamada = string.Empty;
                        short quantidadeTransacoes = 0;
                        short numeroTransacaoEnviada = 0;
                        string reservaDados = string.Empty;
                        string dados;

                        do
                        {
                            dados = (envio.CodigoBandeira.ToString("000") +
                                               envio.Estabelecimentos.Count.ToString("0000") +
                                               string.Join("", from i in envio.Estabelecimentos select i.ToString("000000000")).PadRight(27007, '0')).PadRight(30000, ' ');

                            Log.GravarLog(EventoLog.ChamadaHIS, new { programaChamador, sistema, usuario, dataInicial, dataFinal, mensagemRetorno, indicadorReChamada, quantidadeTransacoes, numeroTransacaoEnviada, reservaDados, dados });

                            short codigoRetorno;

                            if (!TesteHelper.IsAmbienteDesenvolvimento())
                            {
                                codigoRetorno = cliente.ConsultarRetencao(programaChamador, sistema, ref usuario, dataInicial, dataFinal, ref mensagemRetorno, ref indicadorReChamada, ref quantidadeTransacoes, ref numeroTransacaoEnviada, ref reservaDados, ref dados);
                            }
                            else
                            {
                                codigoRetorno = 10;
                                dados = String.Empty;
                                //dados = "000011PRRET2011195900010000000000029212700007                                                                                                                             DC20.06.201223.03.201222.06.2012004525710074149518MasterCard  00001VDA CREDITO                                                                     00000000000006138DC28.06.201231.03.201202.07.2012004525710033549958MasterCard  00001VDA CREDITO                                                                     00000000000006138D1               0000000000000000000000 0        0                0TOTAL DE CREDITOS RETIDOS NO PERIODO REFERENTE AO PROCESSO                      00000000000012276D2               0000000000000000000000 0        0                0DEBITOS REFERENTE AO PROCESSO NR RET201119590001                                                0DD20.06.2012                    004525710000099999                0CONSULTA SERASA REF.06/11 - PV 004525710                                        00000000000001500DD20.06.2012                    004525710000718151                0VDA DEBITO                                                                      00000000000000933DD20.06.2012                    004525710000718152                0AL.POS/TX.CONECT REF.06/11 - PV 004525710                                       00000000000001333DD20.06.2012                    004525710004525710                0VDA DEBITO                                                                      00000000000146523DD20.06.2012                    004525710004525710                0VDA DEBITO                                                                      00000000000141838D1               0000000000000000000000 0        0                0TOTAL DE DEBITOS RETIDOS REFERENTE AO PROCESSO                                  00000000000292127                 0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                                              0000000000000000000000                                                                                                                             00002000010000000000029212700000000000012276";
                            }

                            statusRetornoDTO = new StatusRetornoDTO(codigoRetorno, mensagemRetorno, FONTE_METODO);
                            Log.GravarLog(EventoLog.RetornoHIS, new { codigoRetorno, mensagemRetorno, usuario, indicadorReChamada, quantidadeTransacoes, numeroTransacaoEnviada, reservaDados, dados });

                            ConsultarRetencaoRetornoDTO retornoDTO = TradutorResultadoConsultaSuspensao.TraduzirRetornoConsultarRetencao(dados);

                            if (result == null)
                            {
                                result = retornoDTO;
                            }
                            else
                            {
                                result.Registros.AddRange(retornoDTO.Registros);

                                result.Totais = retornoDTO.Totais;
                            }

                        } while (indicadorReChamada == "S");
                    }

                    Log.GravarLog(EventoLog.FimAgente, new { result });

                    return result;
                }
                catch (Exception ex)
                {
                    Log.GravarErro(ex);
                    throw new PortalRedecardException(CODIGO_ERRO, FONTE, ex);
                }
            }
        }
        #endregion
    }
}
